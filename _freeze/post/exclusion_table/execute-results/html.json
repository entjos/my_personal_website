{
  "hash": "67e613148bb45cf0f362f017b746a18c",
  "result": {
    "markdown": "---\ntitle: \"{ExclusionTable} a package for keeping track of exclusions and inclusions\"\nauthor: \"Joshua Philipp Entrop\"\ndate: \"2021-11-01\"\ncategories: [R]\ntags: [R, ExclusionTable]\ndraft: FALSE\n---\n\n\nIn today's blog post we will take a look at a package that allows you to keep track of the number of observations that you in- or exclude from your dataset or study population.\n\nIn epidemiological studies we often want to limit our study population based on some inclusion and exclusion criteria. This is also the case in other areas such as social science or econometrics. Although there are a lot of nice functions in R to exclude observations from your study population, i.e. in the packages <TT>{base}</TT>, <TT>{dplyr}</TT> or <TT>{data.table}</TT>, there is no function that records how many observations you excluded or included in each step. Hence, I created a package <TT>{ExclusionTable}</TT> which includes the <TT>exclusion_table()</TT> function that does exactly this. In this blog post, I would like to introduce the function and show some of its features. The blog post also serves as a vignette for the <TT>{ExclusionTable}</TT> package.\n\nFor this let's imagine we are working with data from the the US National Health and Nutrition Examination Study (NHANES) from the years 2009 to 2012. This dataset includes questionnaire data on health related topics for a sample of the US population. To load the data we can conveniently use the <TT>{NHANES}</TT> package on CRAN. If you would like to get more information on the dataset please take a look at <TT>?NHANES</TT>.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load packages\nlibrary(NHANES)  # NHANES dataset\nlibrary(dplyr)   # Data manipulation\nlibrary(remotes) # Install packages from GitHub\n\n# Attach data\ndata(\"NHANES\")\n```\n:::\n\n\nUsually we don't want to use the whole study population for our analysis but only a subset. Let's assume we are interested in a subset of older females included in the NHANES dataset who have complete information on BMI. For this we would like to include females aged 65 years or above and exclude all individuals with missing information on BMI. If we would like to do this in <TT>R</TT> we could for example use <TT>dplyr::filter()</TT>.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Subset NHANES data using dplyr::filter\nNHANES_subset <- NHANES %>% \n  filter(Gender == \"female\",\n         Age    >= 65,\n         !is.na(BMI))\n\n# Print number of observations\nnrow(NHANES_subset)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 731\n```\n:::\n:::\n\n\nThe code above obtained the subpopulation of the study population that we are interested in. For this we excluded 9,269 of the 10,000 observations leaving us with 731 observations in the dataset. However, we don't know how many observations we excluded at each step, i.e. based on each of the three criteria. Often we want to report those numbers in our articles, e.g. in study population flow-charts. That's were the <TT>{ExclusionTable}</TT> package makes your life easier. First let's install the package from GitHub.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install {ExclusionTable} from GitHub\nremotes::install_github(\"entjos/ExclusionTable\",\n                        ref = \"main\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load package\nlibrary(ExclusionTable)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'ExclusionTable' was built under R version 4.3.2\n```\n:::\n:::\n\n\nThe <TT>ExclusionTable::exclusion_table()</TT> function takes as first argument a dataframe and as second and third arguments a character vector of inclusion and exclusion criteria, respectively. Let's try this function for our previous exclusions and inclusions. For this let's set <TT>keep_data = FALSE</TT>, since we are for now only interested in obtaining the numbers of excluded individuals.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexclusion_table(NHANES,\n                inclusion_criteria = c(\"Gender == 'female'\",\n                                       \"Age    >= 65\"),\n                exclusion_criteria = \"is.na(BMI)\",\n                keep_data = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n===============================================\nExcluded the following observations:\n===============================================\nExclusions based on INCLUSION criteria\n\n           inclusion n_prior n_post n_excluded\n1 Gender == 'female'   10000   5020       4980\n2       Age    >= 65    5020    739       4281\n3              TOTAL   10000    739       9261\n\nExclusions based on EXCLUSION criteria\n\n   exclusion n_prior n_post n_excluded\n1 is.na(BMI)     739    731          8\n2      TOTAL     739    731          8\n\n===============================================\n```\n:::\n:::\n\n\nThe output above shows us that we excluded 4,980 male individuals from our dataset and 4,281 individuals that were aged below 65. In total we excluded 9,261 individuals based on our inclusion criteria. Additionally, we excluded 8 individuals with missing information on BMI. Hence, we end up with a dataset including 731 individuals as before. Please notice the difference between inclusion and exclusion criteria: Individuals who do not meet the inclusion criteria will be excluded whereas individuals who do meet the exclusion criteria will excluded. Also, <TT>ExclusionTable::exclusion_table(}</TT> will always apply the exclusion criteria after the inclusion criteria.\n\nIf we want to use strings in the filter statements, we can use single quotation marks within the strings, e.g. <TT>\"Gender == 'female'\"</TT>.\n\nThis looks already really nice, but let's improve the output a little bit and supply some labels for our inclusion and exclusion criteria.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexclusion_table(NHANES,\n                inclusion_criteria = c(\"Gender == 'female'\",\n                                       \"Age    >= 65\"),\n                exclusion_criteria = \"is.na(BMI)\",\n                labels_inclusion   = c(\"Get females\",\n                                       \"Age is >= 65\"),\n                labels_exclusion   = \"Missing BMI\",\n                keep_data = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n=========================================\nExcluded the following observations:\n=========================================\nExclusions based on INCLUSION criteria\n\n     inclusion n_prior n_post n_excluded\n1  Get females   10000   5020       4980\n2 Age is >= 65    5020    739       4281\n3        TOTAL   10000    739       9261\n\nExclusions based on EXCLUSION criteria\n\n    exclusion n_prior n_post n_excluded\n1 Missing BMI     739    731          8\n2       TOTAL     739    731          8\n\n=========================================\n```\n:::\n:::\n\n\nNow we get nice labels in our inclusion and exclusion tables. Let's next actually keep the data and take a look at the output object of the <TT>exclusion_table()</TT> function. For this we will set <TT>keep_data = TRUE</TT>.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNHANES_ex_tab <- \n  exclusion_table(NHANES,\n                  inclusion_criteria = c(\"Gender == 'female'\",\n                                         \"Age    >= 65\"),\n                  exclusion_criteria = \"is.na(BMI)\",\n                  labels_inclusion   = c(\"Get females\",\n                                         \"Age is >= 65\"),\n                  labels_exclusion   = \"Missing BMI\",\n                  keep_data = TRUE)\n\n# Print structure\nstr(NHANES_ex_tab, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nList of 3\n $ table_in:'data.frame':\t3 obs. of  4 variables:\n $ table_ex:'data.frame':\t2 obs. of  4 variables:\n $ dataset :'data.frame':\t731 obs. of  76 variables:\n - attr(*, \"class\")= chr \"exl_tbl\"\n```\n:::\n:::\n\n\nThe <TT>exclusion_table()</TT> function returns an <TT>exl_tbl</TT> objects which is a list with maximum three <TT>data.frame</TT>s, depending on the options used. The <TT>\\[\\[\"table_in\"\\]\\]</TT> and <TT>\\[\\[\"table_ex\"\\]\\]</TT> <TT>data.frame</TT>s include the tables with the numbers of individuals excluded due to our inclusion and exclusion criteria, respectively. Those are the tables we have seen previously. The <TT>\\[\\[\"dataset\"\\]\\]</TT> <TT>data.frame</TT> includes the cleaned dataset without the excluded observations. You can use this dataset for your further analysis. I usually assign the dataset to another object to access it more easily.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNAHANES_cleaned <- NHANES_ex_tab[[\"dataset\"]]\n\nnrow(NAHANES_cleaned)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 731\n```\n:::\n:::\n\n\nSometimes you might also be interested in using a variable from your global environment in the filter call. I often do this when I want to filter certain diagnosis codes, that I stored in a character variable in my environment. However, since we don't have any diagnosis codes in this dataset we will take a look at certain number of rooms in the individual's home. This information is stored in the variable <TT>HomeRooms</TT>. Let's assume we would like to only include individuals who live in a home with 2, 4 and 9 rooms.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nroom_selection <- c(2, 4, 9)\n\nexclusion_table(NHANES,\n                inclusion_criteria = c(\"HomeRooms %in% obj$room_selection\"),\n                labels_inclusion   = c(\"2, 4, 9 rooms\"),\n                obj = list(room_selection = room_selection))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n==========================================\nExcluded the following observations:\n==========================================\nExclusions based on INCLUSION criteria\n\n      inclusion n_prior n_post n_excluded\n1 2, 4, 9 rooms   10000   2283       7717\n2         TOTAL   10000   2283       7717\n\n==========================================\n```\n:::\n:::\n\n\nBy supplying objects as names lists to the <TT>obj</TT> argument of <TT>exclusion_table</TT> we can access them in our filter calls using <TT>obj\\$\\<name of your object\\></TT>.\n\nTo summarise the <TT>ExclusionTable::exclusion_table()</TT> function allows you to easily keep track of your exclusion and inclusion criteria and helps you to report how many individuals you excluded at each step. If you have any questions or suggestions please write me an [email](mailto:joshuaentrop@posteo.de) or contact me on [Twitter](twitter.com/entjos) or file an issue on [GitHub](https://github.com/entjos/ExclusionTable).\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}