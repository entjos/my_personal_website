{
  "hash": "2819654e691e49176be0a75999db9c88",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Comparing the confidence intervals of a Weibull model estimated with flexsurvreg() and optimx()\"\ndescription: \"This blog post is a follow up on my [previous post](https://www.joshua-entrop.com/post/optim_weibull_reg.html) on optimising a Weibull regression model using `optimx()`. This time I'll try to find a solution for the discrepancy between the confidence interval estimates of the Weibull hazard function estimated with `optimx()` and `flexsurvreg()`.\"\nauthor: \"Joshua Philipp Entrop\"\ndate: '2020-10-25'\noutput: html_document\ncategories: [Optimisation, R, survival analysis]\ntags: [R, survival analysis, manual optimisation]\ndraft: FALSE\n---\n\n\n[R Code](https://www.joshua-entrop.com/rcode/optim_weibull_reg_follow_up.txt){.btn .btn-outline-primary .btn role=\"button\"}\n\nThis blog post is a follow up on my [previous post](https://www.joshua-entrop.comhttps://www.joshua-entrop.com/post/optim_weibull_reg.html) on optimising a Weibull regression model using `optimx()`. This time I'll try to find a solution for the discrepancy between the confidence interval estimates of the Weibull hazard function estimated with `optimx()` and `flexsurvreg()`.\n\nThis post begins where my previous one ended. Hence, I suggest you to read my [previous post](https://www.joshua-entrop.comhttps://www.joshua-entrop.com/post/optim_weibull_reg.html) before reading this one. Also, I will use the `R` script of my previous post as starting point for this post. You can find the whole plain `R` script used in this post in `.txt` format [here](https://www.joshua-entrop.com/rcode/optim_weibull_reg_follow_up.txt).\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](optim_weibull_reg_follow_up_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nThis is the figure where my last post ended. I compared the hazard function $h(t)$ of the Weibull model estimated manually using `optimx()` with the hazard function of an identical model estimated with `flexsurvreg()`. Interestingly, the hazard functions were identical, but there were considerable differences in the estimates of the confidence intervals across follow-up time, as you can see in the figure above. Unfortunately, I couldn't come up with an explanation for this discrepancy. However, I was lucky and got help from [Andrea Discacciati](https://staff.ki.se/people/anddis), a colleague at Karolinska Institutet. He pointed out that the `flexsurvreg()` function from the `{flexsurvreg}` package uses the log-hazard function ($\\ln h(t)$) for estimating confidence intervals whereas I used the hazard function ($h(t)$) in my post instead. Working on the log-scale allows to transform the multiplicative components of the hazard function into additive components, since $\\ln xy = \\ln x + \\ln y$. This is usually done to increase the precision of the computation process, since multiplication usually comes with a higher loss in precision compared to summation. Hence, using the hazard function instead of the log-hazard function might lead to the difference in the estimates for the confidence intervals of the hazard functions, that we can see in the figure above.\n\nSo let's try to use the log-hazard instead of the hazard for the computation of our survival function together with its confidence intervals. First the hazard function is, as explained in my previous post, defined by\n\n$$\nh(t) = \\gamma \\lambda t ^{\\gamma - 1}.\n$$\n\nLet's then compute the hazard function and the confidence intervals using the hazard function on the identity scale.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 12. Compare h(t) with CIs using identity and log-scale ----------------------\n\n# Get coefficents for Newuoa optimisation\nnewuoa_coef <- coef(opt)[\"newuoa\", ]\n\n# 12.1 Estimate h(t) with CIs using hazard function on identity scale =========\n\n# Compute CIs for a 60 year old female across time\nhaz_optim_female <- lapply(as.list(seq(0.01, 1000.01, 10)), function(t){\n  \n  g <- paste(\"exp(gamma) * exp(alpha + beta_female + 60 * beta_age) *\", t,\n             \"^ (exp(gamma) - 1)\")\n  \n  fit <- deltaMethod(newuoa_coef, g, solve(hessian_m))\n  \n  data.frame(time     = t,\n             estimate = fit[, \"Estimate\"],\n             ci_low   = fit[, \"2.5 %\"],\n             ci_up    = fit[, \"97.5 %\"])\n  \n}) %>%\n  bind_rows()\n```\n:::\n\n\nIn the next step we need to compute the hazard function and its confidence interval on the log-scale $\\ln h(t)$. The log-hazard function can be written as\n\n$$\n\\ln h(t) = \\ln \\gamma + \\ln \\lambda + \\ln t  (\\exp(\\gamma) - 1).\n$$\n\nLet's use this formula to calculate the confidence interval of the hazard function using the same function as above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 12.2 Estimate h(t) with CIs using hazard function on log scale ==============\n\n# Compute CIs for a 60 year old female across time\nhaz_optim_female_log <- lapply(as.list(seq(0.01, 1000.01, 10)), function(t){\n  \n  g <- paste(\"(gamma) + (alpha + beta_female + 60 * beta_age) +\", log(t),\n             \"* (exp(gamma) - 1)\")\n  \n  fit <- deltaMethod(newuoa_coef, g, solve(hessian_m))\n  \n  data.frame(time     = t,\n             estimate = exp(fit[, \"Estimate\"]),\n             ci_low   = exp(fit[, \"2.5 %\"]),\n             ci_up    = exp(fit[, \"97.5 %\"]))\n  \n}) %>%\n  bind_rows()\n```\n:::\n\n\nWe can now compare the confidence intervals obtained by these two different computations by plotting their hazard functions and confidence intervals.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 12.3 Create plot comparing both estimations =================================\n\npar(mfcol = c(1, 2))\n\n# 10.2 Plot hazard curve with CIs =============================================\n\n# create list of both data frames\n\nlist_haz_optim_female <- list(haz_optim_female,\n                              haz_optim_female_log)\n\ninvisible(\nmapply(df = list(haz_optim_female, haz_optim_female_log),\n       titles = c(\"Based on hazard function\",\n                  \"Based on log-hazard function\"),\n       FUN = function(df, titles){\n         \n         plot(df$time,\n              df$estimate,\n              ylim = c(0, 0.005),\n              type = \"n\",\n              xlab = \"Time in Days\",\n              ylab = \"h(t)\",\n              main = titles)\n         polygon(c(df$time, rev(df$time)),\n                 c(df$ci_low, rev(df$ci_up)),\n                 border = NA,\n                 col = \"grey\")\n         plot(weibull_model, type = \"hazard\",\n              newdata = data.frame(age = 60,\n                                   female = 1),\n              add = TRUE)\n         lines(df$time,\n               df$estimate)\n         legend(\"topleft\",\n                inset = 0.01,\n                cex = 0.8,\n                fill = c(\"black\", \"red\"),\n                legend = c(\"Optimix()\", \"flexsurvreg()\"),\n                box.lty = 0)\n       })\n)\n```\n\n::: {.cell-output-display}\n![](optim_weibull_reg_follow_up_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nIn this figure we can see the hazard function and its confidence interval (gray area) for both computation approaches. The estimates yielded by working on the identity scale are shwon on the left and the estimates yieled by working on the log-scale are shown on the right. At the same time we see the estimates yielded by estimating the same model with `flexsurvreg()` (red lines). As we can see, working on the log-scale yielded estimates very much closer to the estimates obtained with `flexsurvreg()` compared to the model using the identity scale.\n\nHence, it seems as this difference between working on the identity and log-scale for computing the confidence intervals may explain a big part of the discrepancy between the confidence intervals obtained with `flexsurvreg()` and `optimx()`, which we can see in the first figure above. The remaining differences are likely due to the fact, that the `flexsurvreg()` function uses the bootstrap method instead of the delta method to estimate confidence intervals for the hazard function.\n\nIn this post we compared the confidence intervals of a hazard function obtained by applying the delta method to the hazard function on the identity scale ($h(t)$) and on the log-scale ($\\ln h(t)$). As [Andrea Discacciati](https://staff.ki.se/people/anddis) pointed out both approaches assymptotically yield the same results. However, working on the log-hazard scale is favorable for finite samples.\n",
    "supporting": [
      "optim_weibull_reg_follow_up_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}